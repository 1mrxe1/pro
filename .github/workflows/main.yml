name: Python Bot (Stop Test)

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # تشغيل البوت ثم إيقافه بعد 10 دقائق فقط
      - name: Run bot with shutdown test
        run: |
          echo "🚀 Starting bot..."

          # 🟢 الطريقة 1: PID tracking
          python main.py > bot.log 2>&1 &
          BOT_PID=$!

          sleep 600   # 10 دقائق

          echo "🛑 Sending SIGTERM to bot..."
          kill -TERM $BOT_PID || true
          sleep 5
          kill -9 $BOT_PID 2>/dev/null || true
          echo "✅ Bot stopped (PID tracking)."

          # 🟢 الطريقة 2: timeout (بديل)
          # echo "🚀 Starting bot with timeout..."
          # timeout -s TERM 600 python main.py > bot.log 2>&1 || true
          # echo "✅ Bot stopped (timeout)."

      - name: Show bot logs
        run: cat bot.log
