name: Advanced Python Bot

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  push:
    paths-ignore:
      - 'main.py'
      - '.github/workflows/**'

env:
  PYTHON_VERSION: '3.11'
  MAX_RETRIES: 3
  RETRY_DELAY: 30

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write
      actions: write
    
    steps:
      # ----------------------------
      # 1. Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù…Ø¹Ø¯Ù„)
      # ----------------------------
      - name: Checkout with enhanced settings
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python with caching
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies with retry logic
        run: |
          install_dependencies() {
            if [ -f requirements.txt ]; then
              pip install --upgrade pip
              pip install -r requirements.txt
            fi
          }
          
          for i in $(seq 1 $MAX_RETRIES); do
            if install_dependencies; then
              echo "Dependencies installed successfully"
              break
            else
              echo "Attempt $i failed, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi
          done

      # ----------------------------
      # 2. Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„ØªÙ†ÙÙŠØ°
      # ----------------------------
      - name: Create backup of main.py
        id: backup
        run: |
          if [ -f main.py ]; then
            cp main.py main.py.backup
            echo "âœ… Backup created"
          else
            echo "âŒ main.py not found!"
            exit 1
          fi

      # ----------------------------
      # 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
      # ----------------------------
      - name: Run bot with monitoring
        id: run_bot
        run: |
          echo "ğŸ¤– Starting bot execution..."
          start_time=$(date +%s)
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ timeout
          timeout 350m python main.py
          exit_code=$?
          
          end_time=$(date +%s)
          execution_time=$((end_time - start_time))
          
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "execution_time=$execution_time" >> $GITHUB_OUTPUT
          
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Bot executed successfully"
          elif [ $exit_code -eq 124 ]; then
            echo "â° Bot execution timed out"
          else
            echo "âŒ Bot execution failed with code: $exit_code"
          fi

      # ----------------------------
      # 4. ÙƒØ´Ù Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      # ----------------------------
      - name: Detect changes in main.py
        id: detect_changes
        run: |
          changes_detected=false
          
          # Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
          if [ -f main.py.backup ] && [ -f main.py ]; then
            if ! cmp -s main.py.backup main.py; then
              changes_detected=true
              echo "ğŸ”„ Changes detected in main.py"
              
              # Ø¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
              echo "ğŸ“‹ Changes made:"
              diff main.py.backup main.py || true
            fi
          fi
          
          if [ "$changes_detected" = "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected"
          fi
          
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
          rm -f main.py.backup

      # ----------------------------
      # 5. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub
      # ----------------------------
      - name: Configure Git for push
        if: steps.detect_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote -v
          git status

      - name: Commit and push changes
        if: steps.detect_changes.outputs.has_changes == 'true'
        run: |
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø¯Ù„
          git add main.py
          
          # Ø¹Ù…Ù„ commit
          git commit -m "ğŸ¤– Auto-update: Bot modified main.py [skip ci]"
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© push Ù…Ø¹ retry
          for attempt in {1..3}; do
            if git push origin HEAD:${{ github.ref }}; then
              echo "âœ… Changes pushed successfully on attempt $attempt"
              break
            else
              echo "âš ï¸ Push attempt $attempt failed"
              if [ $attempt -lt 3 ]; then
                sleep 10
              else
                echo "âŒ All push attempts failed"
                exit 1
              fi
            fi
          done

      # ----------------------------
      # 6. Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
      # ----------------------------
      - name: Generate execution report
        if: always()
        run: |
          echo "ğŸ“Š === BOT EXECUTION REPORT ==="
          echo "Execution time: ${{ steps.run_bot.outputs.execution_time }} seconds"
          echo "Exit code: ${{ steps.run_bot.outputs.exit_code }}"
          echo "Changes detected: ${{ steps.detect_changes.outputs.has_changes }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "=============================="

      # ----------------------------
      # 7. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      # ----------------------------
      - name: Handle failures
        if: failure()
        run: |
          echo "âŒ Workflow failed at step: ${{ github.step }}"
          echo "Please check the logs for details"

  # ----------------------------
  # 8. Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ©
  # ----------------------------
  health-monitor:
    runs-on: ubuntu-latest
    needs: run-bot
    if: always()
    
    steps:
      - name: Analyze execution results
        run: |
          echo "ğŸ” Health Monitor Analysis"
          echo "Bot job status: ${{ needs.run-bot.result }}"
          echo "Execution time: ${{ needs.run-bot.outputs.execution_time }} seconds"
          echo "Changes made: ${{ needs.run-bot.outputs.has_changes }}"
