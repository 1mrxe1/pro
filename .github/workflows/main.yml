name: Python Bot (Artifacts Test)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø¬ÙˆØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: bot-data
        continue-on-error: true   # Ù…Ø§ ÙŠÙØ´Ù„ Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ artifacts Ø£ÙˆÙ„ Ù…Ø±Ø©

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙˆØªØ®Ø²ÙŠÙ† Ù„ÙˆØºØ§ØªÙ‡ + Ù‚ØªÙ„Ù‡ Ù‚Ø¨Ù„ 30 Ø«Ø§Ù†ÙŠØ©
      - name: Run bot with timed shutdown
        run: |
          echo "ğŸš€ Starting bot..."
          (sleep 870 && echo "ğŸ›‘ Killing bot..." && pkill -f "python main.py") &
          python main.py > bot.log 2>&1 || true

      # Ø·Ø¨Ø§Ø¹Ø© Ù„ÙˆØº Ø§Ù„Ø¨ÙˆØª ÙÙ‚Ø·
      - name: Show bot logs
        run: cat bot.log

      # Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒÙ€ artifacts
      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: bot-data
          path: |
            *.session
            *.db
            *.json
            *.png
            *.jpg
            *.jpeg
            *.gif
            *.bmp
            *.webp
            !main.py
            bot.log
