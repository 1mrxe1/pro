name: Python Bot

on:
  workflow_dispatch:   # تشغيل يدوي
  schedule:
    - cron: "0 */6 * * *"   # كل 6 ساعات

permissions:
  contents: write   # لازم حتى يقدر يكتب للريبو

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # مهم عشان يقدر يعمل push

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run bot
        run: python main.py

      - name: Commit generated files (only beside main.py)
        run: |
          set -e
          MAIN_PATH="main.py"
          MAIN_DIR="$(dirname "$MAIN_PATH")"
          [ "$MAIN_DIR" = "." ] && MAIN_DIR="./"   # root

          echo "Searching for changed files next to $MAIN_PATH"

          # فقط الملفات بنفس مجلد main.py (ليست مجلدات)
          files_to_add=$(find "$MAIN_DIR" -maxdepth 1 -type f ! -name "$(basename "$MAIN_PATH")")

          if [ -n "$files_to_add" ]; then
            echo "Files to add/commit:"
            echo "$files_to_add"

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add $files_to_add
            git commit -m "chore(bot): update generated files [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "No files changed beside main.py"
          fi
