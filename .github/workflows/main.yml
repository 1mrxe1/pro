name: Advanced Python Bot

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  push:
    paths-ignore:
      - 'main.py'
      - '.github/workflows/**'

env:
  PYTHON_VERSION: '3.11'
  MAX_RETRIES: 3
  RETRY_DELAY: 30

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write
      actions: write
    
    steps:
      # ----------------------------
      # 1. Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ÙŠ
      # ----------------------------
      - name: Checkout with enhanced settings
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          sparse-checkout: |
            !.git
            *
          persist-credentials: true

      - name: Setup Python with caching
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies with retry logic
        run: |
          install_dependencies() {
            if [ -f requirements.txt ]; then
              pip install --upgrade pip
              pip install -r requirements.txt
            fi
          }
          
          for i in $(seq 1 $MAX_RETRIES); do
            if install_dependencies; then
              echo "Dependencies installed successfully"
              break
            else
              echo "Attempt $i failed, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi
          done

      # ----------------------------
      # 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ØªÙ‚Ø¯Ù…Ø©
      # ----------------------------
      - name: Create execution environment
        id: setup_env
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© ØªÙ†ÙÙŠØ° Ù…Ø¹Ø²ÙˆÙ„Ø©
          EXECUTION_DIR="/tmp/bot_execution_$(date +%s)"
          mkdir -p $EXECUTION_DIR
          cp -r . $EXECUTION_DIR/
          cd $EXECUTION_DIR
          
          # Ø­ÙØ¸ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ù…Ù„Ù
          if [ -f main.py ]; then
            sha256sum main.py > main.py.sha256.before
            echo "execution_dir=$EXECUTION_DIR" >> $GITHUB_OUTPUT
          else
            echo "âŒ main.py not found!"
            exit 1
          fi

      - name: Run bot with monitoring
        id: run_bot
        run: |
          cd ${{ steps.setup_env.outputs.execution_dir }}
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø´Ø§Ù…Ù„
          echo "ğŸ¤– Starting bot execution..."
          start_time=$(date +%s)
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… timeout Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¯
          timeout 350m python main.py 2>&1 | tee bot_execution.log
          exit_code=${PIPESTATUS[0]}
          
          end_time=$(date +%s)
          execution_time=$((end_time - start_time))
          
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "execution_time=$execution_time" >> $GITHUB_OUTPUT
          
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Bot executed successfully"
          else
            echo "âŒ Bot execution failed with code: $exit_code"
          fi

      # ----------------------------
      # 3. ÙƒØ´Ù Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
      # ----------------------------
      - name: Advanced change detection
        id: detect_changes
        run: |
          cd ${{ steps.setup_env.outputs.execution_dir }}
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
          changes_detected=false
          
          # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: checksum comparison
          if [ -f main.py.sha256.before ] && [ -f main.py ]; then
            sha256sum -c main.py.sha256.before >/dev/null 2>&1 || changes_detected=true
          fi
          
          # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 2: content comparison
          if [ "$changes_detected" = "false" ] && [ -f main.py.original ]; then
            if ! cmp -s main.py.original main.py; then
              changes_detected=true
            fi
          fi
          
          # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 3: git status (Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ)
          if [ "$changes_detected" = "false" ]; then
            git status --porcelain | grep -q "main.py" && changes_detected=true
          fi
          
          if [ "$changes_detected" = "true" ]; then
            echo "ğŸ”„ Changes detected in main.py"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ
            cp main.py $GITHUB_WORKSPACE/main.py
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            echo "ğŸ“‹ Change log:"
            if [ -f main.py.original ]; then
              diff -u main.py.original main.py || true
            else
              echo "Original file not available for diff"
            fi
          else
            echo "âœ… No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------
      # 4. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ø¹ GitHub
      # ----------------------------
      - name: Smart GitHub synchronization
        if: steps.detect_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
              const status = execSync('git status --porcelain').toString();
              
              if (status.includes('main.py')) {
                console.log('ğŸ“¦ Preparing to commit changes...');
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Git
                execSync('git config --local user.name "github-actions[bot]"');
                execSync('git config --local user.email "github-actions[bot]@users.noreply.github.com"');
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
                execSync('git add main.py');
                
                // Ø¹Ù…Ù„ commit
                const commitMessage = `ğŸ¤– Auto-update: Bot execution ${new Date().toISOString()}`;
                execSync(`git commit -m "${commitMessage}"`);
                
                // Push Ù…Ø¹ retry logic
                let pushSuccess = false;
                for (let attempt = 1; attempt <= 3; attempt++) {
                  try {
                    execSync('git push origin HEAD:${{ github.ref }}');
                    pushSuccess = true;
                    console.log('âœ… Changes pushed successfully');
                    break;
                  } catch (error) {
                    console.log(`âš ï¸ Push attempt ${attempt} failed: ${error.message}`);
                    if (attempt < 3) {
                      await new Promise(resolve => setTimeout(resolve, 10000)); // 10s delay
                    }
                  }
                }
                
                if (!pushSuccess) {
                  console.log('âŒ All push attempts failed');
                }
              } else {
                console.log('â„¹ï¸ No changes to commit');
              }
            } catch (error) {
              console.log('âŒ Error during synchronization:', error.message);
            }

      # ----------------------------
      # 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      # ----------------------------
      - name: Generate execution report
        if: always()
        run: |
          echo "ğŸ“Š === BOT EXECUTION REPORT ==="
          echo "Execution time: ${{ steps.run_bot.outputs.execution_time }} seconds"
          echo "Exit code: ${{ steps.run_bot.outputs.exit_code }}"
          echo "Changes detected: ${{ steps.detect_changes.outputs.has_changes }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "=============================="
          
          # Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ artifact
          mkdir -p reports
          cat > reports/execution_summary.md << EOF
          # Bot Execution Summary
          - **Timestamp**: $(date)
          - **Duration**: ${{ steps.run_bot.outputs.execution_time }} seconds
          - **Exit Code**: ${{ steps.run_bot.outputs.exit_code }}
          - **Changes Made**: ${{ steps.detect_changes.outputs.has_changes }}
          - **Workflow**: ${{ github.workflow }}
          - **Run ID**: ${{ github.run_id }}
          EOF

      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-execution-logs
          path: |
            ${{ steps.setup_env.outputs.execution_dir }}/bot_execution.log
            reports/execution_summary.md
          retention-days: 7

      # ----------------------------
      # 6. Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°ÙƒÙŠ
      # ----------------------------
      - name: Cleanup execution environment
        if: always()
        run: |
          if [ -n "${{ steps.setup_env.outputs.execution_dir }}" ]; then
            echo "ğŸ§¹ Cleaning up execution environment..."
            rm -rf "${{ steps.setup_env.outputs.execution_dir }}"
          fi

      # ----------------------------
      # 7. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      # ----------------------------
      - name: Handle failures
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `âŒ Bot execution failed in workflow ${{ github.workflow }}`;
            console.log(message);
            
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ (Slack, Discord, etc.)
            // await github.rest.actions.createWorkflowDispatch({...});

  # ----------------------------
  # 8. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ©
  # ----------------------------
  health-monitor:
    runs-on: ubuntu-latest
    needs: run-bot
    if: always()
    
    steps:
      - name: Analyze execution results
        run: |
          echo "ğŸ” Health Monitor Analysis"
          echo "Bot job status: ${{ needs.run-bot.result }}"
          echo "Execution time: ${{ needs.run-bot.outputs.execution_time }}"
          echo "Changes made: ${{ needs.run-bot.outputs.has_changes }}"
